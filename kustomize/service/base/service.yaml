---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    ksonnet.io/component: service
  name: dex
rules:
- apiGroups:
  - dex.coreos.com
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dex
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dex
subjects:
- kind: ServiceAccount
  name: dkube
  namespace: dkube
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dkubeClusterRole
subjects:
- kind: ServiceAccount
  name: dkube
  namespace: dkube
---
apiVersion: v1
data:
  config.yaml: |
    issuer: http://localhost:5556/dex
    storage:
      type: kubernetes
      config:
        inCluster: true
    frontend:
      logoURL: "/dex"
      extra:
        dkubeUrl: "/dex/theme/logo.png"
        favUrl: "/dex/theme/favicon.png"
        mainCss: "/dex/static/main.css"
        styleCss: "/dex/theme/styles.css"
    web:
      http: 0.0.0.0:5556
    telemetry:
      http: 0.0.0.0:5558
    expiry:
      idTokens: "72h"
      signingKeys: "72h"
    staticClients:
    - id: dkube
      redirectURIs:
      - '/callback'
      name: 'Dkube App'
      secret: dkube-secret
    oauth2:
      skipApprovalScreen: true
    enablePasswordDB: true
    staticPasswords:
    - email: L-UNAME
      hash: L-PASSWD
      username: L-UNAME
      userID: L-UNAME

kind: ConfigMap
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-auth-config
  namespace: dkube
---
apiVersion: v1
data:
  fluent.conf: |
    <source>
     @type tail
     path /var/log/containers/*.log
     pos_file /var/log/fluentd-containers-jobs.log.pos
     time_key time
     time_format %Y-%m-%dT%H:%M:%S
     refresh_interval 1s
     open_on_every_update true
     enable_stat_watcher false
     rotate_wait 2
     tag kubernetes_jobs.*
     format json
     read_from_head true
    </source>

    <filter kubernetes_jobs.**>
       @type kubernetes_metadata
    </filter>

    #collecting logs... pod which has labels like logger: dkube (or) logger:dkubepl
    <filter kubernetes_jobs.**>
       @type grep
       <regexp>
          key $.kubernetes.labels.logger
          pattern /^dkube/
       </regexp>
    </filter>

    <filter kubernetes_jobs.**>
        @type record_modifier
        enable_ruby
        <record>
          plpath pllauncher
          training_path jobs
          #check for training job or pipeline  launcher 
          jobuuid ${record.dig("kubernetes", "labels", "jobuuid") ? record.dig("kubernetes", "labels", "jobuuid") : record.dig("kubernetes", "labels", "runid") }
          #check for trail job
          studyuuid ${record.dig("kubernetes", "labels", "studyuuid")}

          finalid ${record.dig("studyuuid") ? record.dig("studyuuid") : record.dig("jobuuid") }

          #pipeline logs are stroing inside logs/pllauncher and training job logs are stroing inside logs/jobs
          fpath ${record.dig("kubernetes", "labels", "runid")? record.dig("plpath") : record.dig("training_path")}

          username ${record.dig("kubernetes", "labels", "username") ? record.dig("kubernetes", "labels", "username") : record.dig("kubernetes", "labels", "workflows_argoproj_io/workflow") }

          container ${record.dig("kubernetes", "container_name")}

          #td-replica-type and tf-replica-index are useful in Distributed job
          temp_log ${record.dig("kubernetes", "labels", "tf-replica-type")}-${record.dig("kubernetes", "labels", "tf-replica-index")}:  ${record.dig("log")}
        
          #check for datajob log or training job log
          training_log ${record.dig("kubernetes", "labels", "tf-replica-type") ? record.dig("temp_log") : record.dig("log")}


          #for trail jobs logs appending trailjobname to logs
          trial_log ${record.dig("kubernetes", "labels", "jobname")}:  ${record.dig("training_log")}

          #pod which has studyuuid label considering as trail job
          final_log ${record.dig("kubernetes", "labels", "studyuuid") ? record.dig("trial_log") : record.dig("training_log")} 

          #for pipeline launcher logs we are not adding extra fields 
          message ${record.dig("kubernetes", "labels", "runid") ? record.dig("log") : record.dig("final_log") }
          #s3 storage path
          s3path ${record.dig("fpath")}/${record.dig("username")}/${record.dig("finalid")}/${record.dig("container")}
        </record>
        #removing unwanted and temp fields
        remove_keys log, stream, docker, kubernetes, final_log, trial_log, training_log, jobuuid, studyuuid, plpath, training_path, temp_log, , username, finalid, container
    </filter>

    <match kubernetes_jobs.**>
       @type s3
       aws_key_id dkube
       aws_sec_key l06dands19s
       s3_endpoint http://dkube-minio-server.dkube:9000/
       s3_bucket dkube
       path system/logs/${s3path}
       s3_object_key_format %{path}/job-log-%{uuid_flush}.%{file_extension}
       store_as text
       force_path_style true
       ssl_verify_peer false
       check_apikey_on_start false
       check_bucket false
       auto_create_bucket false
       <format>
         @type single_value
         message_key message
         add_newline false
       </format>
       <buffer s3path>
         @type file
         path /var/log/td-agent/jobs/${s3path}
         timekey 10s           
         timekey_wait 10s  
         timekey_use_utc true  
         chunk_limit_size 256m
         flush_thread_count 8
         retry_forever true
         overflow_action throw_exception
         retry_type periodic
         retry_wait 10s
         flush_mode interval
         flush_interval 30s
         flush_at_shutdown true
       </buffer>
    </match>
kind: ConfigMap
metadata:
  name: dkube-log-collector
  namespace: dkube
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube
  namespace: dkube
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
rules:
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - update
  - patch
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  labels:
    ksonnet.io/component: service
  name: dkube-proxy
  namespace: dkube
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dkube-proxy
subjects:
- kind: ServiceAccount
  name: dkube-proxy
  namespace: dkube
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: d3auth
    ksonnet.io/component: service
  name: dkube-auth-server
  namespace: dkube
spec:
  ports:
  - name: dex-s
    port: 5556
    protocol: TCP
    targetPort: 5556
  - name: authn
    port: 3001
    protocol: TCP
    targetPort: 3001
  selector:
    app: dkube-auth
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-master
    ksonnet.io/component: service
  name: dkube-controller-headless-master
  namespace: dkube
spec:
  clusterIP: None
  ports:
  - name: dkube-d3api
    port: 5000
    protocol: TCP
    targetPort: 5000
  selector:
    app: dkube-controller-master
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-master
    ksonnet.io/component: service
  name: dkube-controller-master
  namespace: dkube
spec:
  ports:
  - name: dkube-d3api
    port: 5000
    protocol: TCP
    targetPort: 5000
  - name: dkube-d3pl
    port: 5001
    protocol: TCP
    targetPort: 5001
  - name: dkube-d3mlflow
    port: 5002
    protocol: TCP
    targetPort: 5002
  selector:
    app: dkube-controller-master
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-controller-worker
    ksonnet.io/component: service
  name: dkube-controller-worker
  namespace: dkube
spec:
  ports:
  - port: 5000
    protocol: TCP
    targetPort: 5000
  selector:
    app: dkube-controller-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-docs
  namespace: dkube
spec:
  ports:
  - name: serve
    port: 8888
    protocol: TCP
    targetPort: 80
  selector:
    app: dkube-tools
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-downloader
  namespace: dkube
spec:
  ports:
  - port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-controller-worker
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9401"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-gpu-exporter
    ksonnet.io/component: service
  name: dkube-exporter
  namespace: dkube
spec:
  ports:
  - name: http-metrics
    port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-ext
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-operator-api-proxy
  namespace: dkube
spec:
  ports:
  - name: dfabproxy
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: dkube-operator-proxy
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dkube-prometheus-grafana
    ksonnet.io/component: service
  name: dkube-prometheus-grafana-proxy
  namespace: dkube
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 3000
  selector:
    app: dkube-prometheus-grafana
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-serving
  namespace: dkube
spec:
  ports:
  - name: serve
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: dkube-tools
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9401"
    prometheus.io/dkube_scrape: "true"
  labels:
    app: dkube-storage-exporter
    ksonnet.io/component: service
  name: dkube-storage-exporter
  namespace: dkube
spec:
  ports:
  - name: http-metrics
    port: 9401
    protocol: TCP
    targetPort: 9401
  selector:
    app: dkube-exporter-deploy
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    ksonnet.io/component: service
    service: dkube-ui
  name: dkube-ui
  namespace: dkube
spec:
  ports:
  - name: ui
    port: 3000
    targetPort: 3000
  selector:
    app: dkube-ui
  type: ClusterIP
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: dkube-authn
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    listener:
      filterChain:
        filter:
          name: envoy.http_connection_manager
          subFilter:
            name: envoy.router
    match:
      context: GATEWAY
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.ext_authz
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
          httpService:
            authorizationRequest:
              allowedHeaders:
                patterns:
                - exact: cookie
                - exact: mode
                - exact: d3-license
                - exact: d3-uname
                - exact: d3-role
                - exact: referer
            authorizationResponse:
              allowedUpstreamHeaders:
                patterns:
                - exact: kubeflow-userid
                - exact: mode
                - exact: d3-license
                - exact: d3-uname
                - exact: d3-role
                - exact: x-cluster-id
            serverUri:
              cluster: outbound|3001||dkube-auth-server.dkube.svc.cluster.local
              timeout: 30s
              uri: http://dkube-auth-server.dkube.svc.cluster.local
          failure_mode_allow: false
          status_on_error: 
            code: GatewayTimeout
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ingressgateway-gzip
  namespace: istio-system
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.compressor
          typed_config:
            '@type': >-
              type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            compressor_library:
              name: text_optimized
              typed_config:
                '@type': >-
                  type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
                memory_level: 3
                window_bits: 10
            response_direction_config:
              common_config:
                content_type:
                  - '*/*'
                min_content_length: 100
  workloadSelector:
    labels:
      istio: ingressgateway

---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: dkube-istio-gateway
  namespace: dkube
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      privateKey: /etc/istio/ingressgateway-certs/tls.key
      serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-auth-server
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dex
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 5556
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dex
    route:
    - destination:
        port:
          number: 5556
        host: dkube-auth-server
    timeout: 60s
  - match:
    - uri:
        prefix: /dkube/v2/login
      method:
        exact: GET
    rewrite:
        uri: /login
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/login
    rewrite:
        uri: /login
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    timeout: 60s
  - match:
    - uri:
        prefix: /dkube/v2/logout
      method:
        exact: GET
    rewrite:
        uri: /logout
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/logout
    rewrite:
        uri: /logout
    route:
    - destination:
        port:
          number: 3001
        host: dkube-auth-server
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-docs
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /docs
      method:
        exact: GET
    rewrite:
        uri: /docs
    route:
    - destination:
        port:
          number: 8888
        host: dkube-docs
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /docs
    rewrite:
        uri: /docs
    route:
    - destination:
        port:
          number: 8888
        host: dkube-docs
    timeout: 60s
  - match:
    - uri:
        prefix: /pagespeed
      method:
        exact: GET
    rewrite:
      uri: /pagespeed
    route:
    - destination:
        host: dkube-docs
        port:
          number: 8888
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /pagespeed
    rewrite:
      uri: /pagespeed
    route:
    - destination:
        host: dkube-docs
        port:
          number: 8888
    timeout: 60s
  - match:
    - uri:
        prefix: /mod_pagespeed_beacon
      method:
        exact: GET
    rewrite:
      uri: /mod_pagespeed_beacon
    route:
    - destination:
        host: dkube-docs
        port:
          number: 8888
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /mod_pagespeed_beacon
    rewrite:
      uri: /mod_pagespeed_beacon
    route:
    - destination:
        host: dkube-docs
        port:
          number: 8888
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-downloader
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/ext
      method:
        exact: GET
    rewrite:
        uri: /dkube/v2
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/ext
    rewrite:
        uri: /dkube/v2
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    timeout: 60s
  - match:
    - uri:
        prefix: /dkube/pipeline/logs/
      method:
        exact: GET
    rewrite:
        uri: /dkube/v2/kubeflow/
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/pipeline/logs/
    rewrite:
        uri: /dkube/v2/kubeflow/
    route:
    - destination:
        port:
          number: 9401
        host: dkube-downloader
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-operator-api-proxy
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/operator
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 8000
        host: dkube-operator-api-proxy
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/operator
    route:
    - destination:
        port:
          number: 8000
        host: dkube-operator-api-proxy
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-prometheus-grafana
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/grafana/
      method:
        exact: GET
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 80
        host: dkube-grafana
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/grafana/
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 80
        host: dkube-grafana
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-prometheus
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/prometheus/api/v1
      method:
        exact: GET
    rewrite:
        uri: /api/v1
    route:
    - destination:
        port:
          number: 9090
        host: dkube-prometheus.dkube.svc.cluster.local
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/prometheus/api/v1
    rewrite:
        uri: /api/v1
    route:
    - destination:
        port:
          number: 9090
        host: dkube-prometheus.dkube.svc.cluster.local
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-serving
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /inference
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /inference
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    timeout: 60s
  - match:
    - uri:
        prefix: /predict
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /predict
    route:
    - destination:
        port:
          number: 8000
        host: dkube-serving
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 3000
        host: dkube-ui
      headers:
        response:
          add:
            Cache-Control: no-cache, max-age=0
    retries:
      attempts: 10
      perTryTimeout: 1s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-argo-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /argo/logs/
      method:
        exact: GET
    rewrite:
        uri: /api/logs/
    route:
    - destination:
        port:
          number: 80
        host: argo-ui.kubeflow.svc.cluster.local
      headers:
        response:
          add:
            Cache-Control: no-cache, max-age=0
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /argo/logs/
    rewrite:
        uri: /api/logs/
    route:
    - destination:
        port:
          number: 80
        host: argo-ui.kubeflow.svc.cluster.local
      headers:
        response:
          add:
            Cache-Control: no-cache, max-age=0
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-katib
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /katib
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 80
        host: katib-ui.kubeflow.svc.cluster.local
      headers:
        response:
          add:
            Cache-Control: no-cache, max-age=0
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /katib
    route:
    - destination:
        port:
          number: 80
        host: katib-ui.kubeflow.svc.cluster.local
      headers:
        response:
          add:
            Cache-Control: no-cache, max-age=0
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-pipeline-ui
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /pipeline
    rewrite:
      uri: /pipeline
    route:
    - destination:
        host: ml-pipeline-ui.kubeflow.svc.cluster.local
        port:
          number: 80
    timeout: 300s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-metadata-grpc
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /ml_metadata
    rewrite:
        uri: /ml_metadata
    route:
    - destination:
        port:
          number: 9090
        host: metadata-envoy-service.kubeflow.svc.cluster.local
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kf-profiles-kfam
  namespace: dkube
spec:
  gateways:
  - dkube-istio-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        prefix: /kfam
    route:
    - destination:
        host: profiles-kfam.kubeflow.svc.cluster.local
        port:
          number: 8081
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-installer
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /installer
      method:
        exact: GET
    rewrite:
        uri: /ui
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /installer
    rewrite:
        uri: /ui
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    timeout: 60s
  - match:
    - uri:
        prefix: /report
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /report
    route:
    - destination:
        port:
          number: 8888
        host: dkube-installer-service
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-controller
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /dkube/v2/controller
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 5000
        host: dkube-controller-worker
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /dkube/v2/controller
    route:
    - destination:
        port:
          number: 5000
        host: dkube-controller-master
    timeout: 60s
  - match:
    - uri:
        prefix: /api/2.0/mlflow
      method:
        exact: GET
    route:
    - destination:
        port:
          number: 5002
        host: dkube-controller-master
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /api/2.0/mlflow
    route:
    - destination:
        port:
          number: 5002
        host: dkube-controller-master
    timeout: 60s
  - match:
    - uri:
        prefix: /ajax-api/2.0/preview/mlflow/artifacts
    route:
    - destination:
        host: dkube-controller-master
        port:
          number: 5002
    timeout: 60s
  - match:
    - uri:
        prefix: /get-artifact
    route:
    - destination:
        host: dkube-controller-master
        port:
          number: 5002
    timeout: 60s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dkube-minio-server
  namespace: dkube
spec:
  hosts:
  - "*"
  gateways:
  - dkube-istio-gateway
  http:
  - match:
    - uri:
        prefix: /minio/
      method:
        exact: GET
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 9000
        host: dkube-minio-server
    retries:
      attempts: 3
      perTryTimeout: 60s
      retryOn: gateway-error,connect-failure,refused-stream
    timeout: 4m
  - match:
    - uri:
        prefix: /minio/
    rewrite:
        uri: /
    route:
    - destination:
        port:
          number: 9000
        host: dkube-minio-server
    timeout: 60s
---
apiVersion: v1
kind: Service
metadata:
  name: dkube-minio-server
  namespace: dkube
spec:
  externalName: dkube-minio-server.dkube-infra.svc.cluster.local
  type: ExternalName
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-grafana-login
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway
      app: istio-ingressgateway
  action: DENY
  rules:
  - to:
    - operation:
        paths: ["/dkube/grafana/login"]
    when:
    - key: destination.port
      values:
      - "8443"
